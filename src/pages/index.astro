---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import FormattedDate from '../components/FormattedDate.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import { getCollection, type CollectionEntry } from 'astro:content';

const pageSize = 10;
const allPosts = (await getCollection('blog'))
	.filter((post) => !post.data.draft)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const totalPages = Math.max(1, Math.ceil(allPosts.length / pageSize));
const posts = allPosts.slice(0, pageSize);
const pathOf = (post: CollectionEntry<'blog'>) => post.data.slug ?? post.id.replace(/\/index$/, '');
const base = import.meta.env.BASE_URL;
const basePath = base.endsWith('/') ? base : `${base}/`;
const slugifySegment = (segment = '') => {
	const raw = String(segment).normalize('NFKC').trim();
	const ascii = raw
		.toLowerCase()
		.replace(/[^a-z0-9]+/g, '-')
		.replace(/^-+|-+$/g, '');
	if (ascii) return ascii;
	return encodeURIComponent(raw).toLowerCase().replace(/%/g, '');
};
const slugifyPath = (p = '') =>
	String(p)
		.split('/')
		.filter(Boolean)
		.map(slugifySegment)
		.join('/');
const assetSlugOf = (post: CollectionEntry<'blog'>) => slugifyPath(pathOf(post));
const ogOf = (post: CollectionEntry<'blog'>) => `${basePath}og/${assetSlugOf(post)}.png`;

const tags = Array.from(new Set(allPosts.flatMap((post) => post.data.tags ?? []))).sort((a, b) => a.localeCompare(b));

const postIndex = allPosts.map((post) => ({
	slug: pathOf(post),
	assetSlug: assetSlugOf(post),
	title: post.data.title,
	description: post.data.description ?? '',
	author: post.data.author ?? 'Unknown',
	tags: post.data.tags ?? [],
	pubDate: post.data.pubDate.toISOString(),
	ogImage: ogOf(post),
}));
const postIndexJson = JSON.stringify(postIndex).replace(/</g, '\\u003c');
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<Header />
		<main class="page">
			<section class="hero">
				<h1>{SITE_TITLE}</h1>
				<p>{SITE_DESCRIPTION}</p>
			</section>
			<section class="filters" aria-label="Filters">
				<div class="tags" id="tags">
					<a class="tag" href={`${basePath}`}>All</a>
					{tags.map((tag) => (
						<a class="tag" href={`?tag=${encodeURIComponent(tag)}`}>{tag}</a>
					))}
				</div>
			</section>
			<section class="list">
				{posts.map((post) => (
						<article class="card">
							<a class="thumb" href={`${basePath}${encodeURI(pathOf(post))}/`}>
								<img src={ogOf(post)} alt={`OGP for ${post.data.title}`} loading="lazy" />
							</a>
						<div class="meta">
							<p class="date"><FormattedDate date={post.data.pubDate} /></p>
							<h2>
								<a href={`${basePath}${encodeURI(pathOf(post))}/`}>{post.data.title}</a>
							</h2>
								<p class="author">{post.data.author ?? 'Unknown'}</p>
							{(post.data.tags ?? []).length > 0 && (
								<div class="tags card-tags" aria-label="Tags">
									{(post.data.tags ?? []).map((tag) => (
										<a class="tag" href={`?tag=${encodeURIComponent(tag)}`}>{tag}</a>
									))}
								</div>
							)}
						</div>
					</article>
				))}
			</section>
			<nav class="pagination" aria-label="Pagination" id="pagination-server">
				<span class="page-info">
					Page <input class="page-input" id="page-jump" type="number" min="1" max={totalPages} value="1" /> / <span id="total-pages">{totalPages}</span>
				</span>
				<div class="page-links">
					{totalPages > 1 && <a class="page-link" href={`?p=2`}>Next</a>}
				</div>
			</nav>
			<script type="application/json" id="post-index" set:html={postIndexJson}></script>
			<script define:vars={{ base: basePath, pageSize, totalPages }}>
				const params = new URLSearchParams(window.location.search);
				const tag = params.get('tag');
				const p = Math.max(1, Number(params.get('p') ?? '1') || 1);

				const nav = document.getElementById('pagination-server');
				const pageLinks = nav?.querySelector('.page-links');
				const totalPagesEl = document.getElementById('total-pages');

				const jump = document.getElementById('page-jump');
				let currentTotalPages = totalPages;
				let currentPage = 1;

				const hrefForPage = (n) => {
					const u = new URL(window.location.href);
					if (tag) u.searchParams.set('tag', tag);
					else u.searchParams.delete('tag');
					if (n === 1) u.searchParams.delete('p');
					else u.searchParams.set('p', String(n));
					return `${u.pathname}${u.search}`;
				};

				const renderPagination = () => {
					if (jump) {
						jump.max = String(currentTotalPages);
						jump.value = String(currentPage);
					}
					if (totalPagesEl) totalPagesEl.textContent = String(currentTotalPages);
					if (!pageLinks) return;
					const prev =
						currentPage > 1
							? `<a class="page-link" href="${hrefForPage(currentPage - 1)}">Prev</a>`
							: '<span class="page-link is-disabled">Prev</span>';
					const next =
						currentPage < currentTotalPages
							? `<a class="page-link" href="${hrefForPage(currentPage + 1)}">Next</a>`
							: '<span class="page-link is-disabled">Next</span>';
					pageLinks.innerHTML = `${prev}${next}`;
				};

				if (jump) {
					jump.addEventListener('change', () => {
						const max = Number(jump.max || String(currentTotalPages)) || currentTotalPages;
						const n = Math.max(1, Math.min(Number(jump.value || '1') || 1, max));
						window.location.href = hrefForPage(n);
					});
				}

				if (tag || p !== 1) {
					const dataEl = document.getElementById('post-index');
					const listEl = document.querySelector('section.list');
					const tagsEl = document.getElementById('tags');

					const all = JSON.parse(dataEl?.textContent || '[]');
					const filtered = tag ? all.filter((post) => (post.tags || []).includes(tag)) : all;
					currentTotalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
					currentPage = Math.min(p, currentTotalPages);
					const slice = filtered.slice((currentPage - 1) * pageSize, currentPage * pageSize);

					if (tagsEl) {
						tagsEl.querySelectorAll('a.tag').forEach((a) => a.classList.remove('is-active'));
						if (tag) {
							tagsEl.querySelectorAll('a.tag').forEach((a) => {
								const u = new URL(a.getAttribute('href') || '', window.location.href);
								if (u.searchParams.get('tag') === tag) a.classList.add('is-active');
							});
						}
					}

					listEl.innerHTML = slice
						.map(
							(post) => `
								<article class="card">
									<a class="thumb" href="${base}${encodeURI(post.slug)}/">
										<img src="${post.ogImage}" alt="OGP for ${post.title}" loading="lazy" />
									</a>
									<div class="meta">
										<p class="date">${new Date(post.pubDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' })}</p>
										<h2><a href="${base}${encodeURI(post.slug)}/">${post.title}</a></h2>
										<p class="author">${post.author}</p>
										${(post.tags || []).length ? `
											<div class="tags card-tags" aria-label="Tags">
												${(post.tags || [])
													.map((t) => `<a class="tag" href="?tag=${encodeURIComponent(t)}">${t}</a>`)
													.join('')}
											</div>
										` : ''}
									</div>
								</article>
							`
						)
						.join('');

					renderPagination();
				}
			</script>
		</main>
		<Footer />
	</body>
</html>

<style is:global>
	.page {
		max-width: 960px;
		margin: 0 auto;
		padding: 2.5rem 1.25rem 3rem;
		display: grid;
		gap: 2rem;
	}

	.hero h1 {
		margin: 0 0 0.5rem;
	}

	.hero p {
		margin: 0;
		color: rgb(var(--gray));
	}

	.list {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	.filters {
		padding: 0.25rem 0;
	}

	.tags {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
	}

	.tag {
		display: inline-flex;
		align-items: center;
		padding: 0.25rem 0.6rem;
		border-radius: 999px;
		border: 1px solid rgb(var(--gray));
		color: rgb(var(--gray-dark));
		text-decoration: none;
		font-size: 0.95rem;
	}

	.tag:hover {
		border-color: rgb(var(--accent));
		color: rgb(var(--accent));
	}

	.tag.is-active {
		border-color: rgb(var(--accent));
		color: rgb(var(--accent));
		font-weight: 700;
	}

	.card {
		display: grid;
		grid-template-columns: 320px 1fr;
		gap: 1rem;
		align-items: start;
		padding: 1rem;
		background: white;
		border-radius: 12px;
		box-shadow: var(--box-shadow);
	}

	.thumb img {
		width: 100%;
		height: auto;
		display: block;
		border-radius: 8px;
	}

	.meta h2 {
		margin: 0.2rem 0 0.4rem;
		font-size: 1.4rem;
	}

	.meta h2 a {
		color: inherit;
		text-decoration: none;
	}

	.author {
		margin: 0.1rem 0;
		color: rgb(var(--gray));
		font-weight: 600;
	}

	.meta h2 a:hover {
		color: rgb(var(--accent));
	}

	.desc {
		margin: 0;
		color: rgb(var(--gray-dark));
	}

	.card-tags {
		margin-top: 0.4rem;
	}

	.date {
		margin: 0;
		color: rgb(var(--gray));
		font-size: 0.95rem;
	}

	@media (max-width: 800px) {
		.card {
			grid-template-columns: 1fr;
		}
	}

	.pagination {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 1rem;
		padding: 0.5rem 0;
		color: rgb(var(--gray));
	}

	.page-links {
		display: inline-flex;
		gap: 0.5rem;
	}

	.page-link {
		display: inline-flex;
		align-items: center;
		padding: 0.25rem 0.6rem;
		border-radius: 8px;
		border: 1px solid rgb(var(--gray));
		color: rgb(var(--gray-dark));
		text-decoration: none;
	}

	.page-link:hover {
		border-color: rgb(var(--accent));
		color: rgb(var(--accent));
	}

	.page-link.is-disabled {
		opacity: 0.5;
		pointer-events: none;
	}

	.page-input {
		width: 4.5rem;
		padding: 0.2rem 0.4rem;
		border-radius: 8px;
		border: 1px solid rgb(var(--gray));
		color: rgb(var(--gray-dark));
	}

	.is-hidden {
		display: none;
	}
</style>
