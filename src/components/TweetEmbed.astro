---
type Props = {
	id?: string;
	url?: string;
};

const { id, url }: Props = Astro.props;

const extractTweetId = (value: string): string | undefined => {
	const trimmed = value.trim();
	if (!trimmed) return undefined;
	const match = trimmed.match(/(?:^|\/)(\d{10,})(?:\b|$)/);
	return match?.[1];
};

const normalizeTweetUrl = (props: Props): string | undefined => {
	if (props.url) return String(props.url).trim() || undefined;
	if (!props.id) return undefined;

	const raw = String(props.id).trim();
	if (!raw) return undefined;

	const looksLikeUrl = /^(https?:\/\/|x\.com\/|twitter\.com\/)/i.test(raw);
	if (looksLikeUrl) {
		// Try to preserve the canonical URL form: /<user>/status/<id>
		try {
			const parsed = new URL(raw.startsWith('http') ? raw : `https://${raw}`);
			const tweetId = parsed.pathname.match(/\/status\/(\d{10,})/i)?.[1] ?? extractTweetId(raw);
			if (!tweetId) return raw;
			const user = parsed.pathname.match(/^\/(?!i\/)([^\/]+)\/status\//i)?.[1];
			if (user) return `https://twitter.com/${user}/status/${tweetId}`;
			return `https://twitter.com/i/web/status/${tweetId}`;
		} catch {
			const tweetId = raw.match(/\/status\/(\d{10,})/i)?.[1] ?? extractTweetId(raw);
			return tweetId ? `https://twitter.com/i/web/status/${tweetId}` : raw;
		}
	}

	const tweetId = raw.match(/^\d{10,}$/) ? raw : extractTweetId(raw);
	return tweetId ? `https://twitter.com/i/web/status/${tweetId}` : undefined;
};

const tweetUrl = normalizeTweetUrl({ id, url });
---

{tweetUrl ? (
	<blockquote class="twitter-tweet">
		<a href={tweetUrl}>{tweetUrl}</a>
	</blockquote>
) : (
	<p role="note">Tweet embed is missing an <code>id</code> or <code>url</code>.</p>
)
